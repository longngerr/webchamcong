<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang ch·ªß - Web Ch·∫•m C√¥ng</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="site-header">
    <h1>üïê Web Ch·∫•m C√¥ng</h1>
    <nav>
      <a href="index.html" class="active">Trang ch·ªß</a>
      <a href="login.html">ƒêƒÉng nh·∫≠p Admin</a>
    </nav>
  </header>

  <main class="container">
    <!-- Form nh·∫≠p ch·∫•m c√¥ng -->
    <section class="card">
      <h2>Ch·∫•m c√¥ng v√†o / ra</h2>
      <!-- On Duty / Off Duty -->
      <div class="duty-buttons">
        <button type="button" id="btnOnDuty" class="btn btn-success">On Duty ‚Äî Ch·∫•m v√†o</button>
        <button type="button" id="btnOffDuty" class="btn btn-secondary">Off Duty ‚Äî Ch·∫•m ra</button>
      </div>
      <div id="dutyStatus" class="duty-status" style="display: none;"></div>
      <form id="formChamCong">
        <div class="form-row">
          <div class="form-group">
            <label for="hoTen">H·ªç v√† t√™n</label>
            <input type="text" id="hoTen" required placeholder="Nh·∫≠p h·ªç t√™n">
          </div>
          <div class="form-group">
            <label for="capBac">C·∫•p b·∫≠c</label>
            <select id="capBac" required>
              <option value="">-- Ch·ªçn c·∫•p b·∫≠c --</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="ghiChu">Ghi ch√∫ (t√πy ch·ªçn)</label>
          <textarea id="ghiChu" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
        </div>
        <p class="form-hint">B·∫•m <strong>On Duty</strong> ƒë·ªÉ ch·∫•m v√†o (ghi gi·ªù v√†o th·ª±c), b·∫•m <strong>Off Duty</strong> ƒë·ªÉ ch·∫•m ra (ghi gi·ªù ra th·ª±c).</p>
      </form>
    </section>

    <!-- B·∫£ng h·ªá s·ªë l∆∞∆°ng -->
    <section class="card">
      <h2>B·∫£ng h·ªá s·ªë l∆∞∆°ng theo c·∫•p b·∫≠c (H·∫° sƒ© ‚Üí ƒê·∫°i t∆∞·ªõng)</h2>
      <div class="table-wrap" id="bangHeSoLuong"></div>
    </section>

    <!-- Danh s√°ch ƒë√£ duy·ªát -->
    <section class="card">
      <h2>Th√¥ng tin ch·∫•m c√¥ng ƒë√£ duy·ªát</h2>
      <div id="alertBox"></div>
      <div class="table-wrap">
        <table class="data-table" id="tableApproved">
          <thead>
            <tr>
              <th>H·ªç t√™n</th>
              <th>C·∫•p b·∫≠c</th>
              <th>H·ªá s·ªë</th>
              <th>Gi·ªù v√†o</th>
              <th>Gi·ªù ra</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="tbodyApproved"></tbody>
        </table>
      </div>
      <div id="emptyApproved" class="empty-state" style="display: none;">
        <p>Ch∆∞a c√≥ b·∫£n ghi n√†o ƒë∆∞·ª£c duy·ªát.</p>
      </div>
    </section>
  </main>

  <script src="js/data.js"></script>
  <script src="js/app.js"></script>
  <script>
    (function () {
      var selectCapBac = document.getElementById('capBac');
      LUONG_CAP_BAC.forEach(function (r) {
        var opt = document.createElement('option');
        opt.value = r.rank;
        opt.textContent = r.rank + ' (h·ªá s·ªë ' + r.heSo + ')';
        selectCapBac.appendChild(opt);
      });

      renderSalaryTable('bangHeSoLuong');

      function loadApproved() {
        var list = getAttendanceList().filter(function (x) { return x.status === 'approved'; });
        var tbody = document.getElementById('tbodyApproved');
        var empty = document.getElementById('emptyApproved');
        tbody.innerHTML = '';
        if (list.length === 0) {
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';
        list.forEach(function (row) {
          var tr = document.createElement('tr');
          var heSo = getHeSoByRank(row.capBac);
          tr.innerHTML =
            '<td>' + escapeHtml(row.hoTen) + '</td>' +
            '<td>' + escapeHtml(row.capBac) + '</td>' +
            '<td>' + heSo + '</td>' +
            '<td>' + formatDate(row.gioVao) + ' ' + formatTime(row.gioVao) + '</td>' +
            '<td>' + formatDate(row.gioRa) + ' ' + formatTime(row.gioRa) + '</td>' +
            '<td>' + escapeHtml(row.ghiChu || '') + '</td>';
          tbody.appendChild(tr);
        });
      }

      function showAlert(msg, type) {
        var box = document.getElementById('alertBox');
        box.innerHTML = '<div class="alert alert-' + (type === 'success' ? 'success' : 'error') + '">' + escapeHtml(msg) + '</div>';
        setTimeout(function () { box.innerHTML = ''; }, 4000);
      }

      function updateDutyUI() {
        var duty = getCurrentDuty();
        var statusEl = document.getElementById('dutyStatus');
        var btnOff = document.getElementById('btnOffDuty');
        if (duty) {
          statusEl.style.display = 'block';
          statusEl.innerHTML = 'ƒêang trong ca: <strong>' + escapeHtml(duty.hoTen) + '</strong> ‚Äî V√†o l√∫c ' + formatDate(duty.gioVao) + ' ' + formatTime(duty.gioVao);
          btnOff.disabled = false;
        } else {
          statusEl.style.display = 'none';
          btnOff.disabled = true;
        }
      }

      document.getElementById('btnOnDuty').addEventListener('click', function () {
        var hoTen = document.getElementById('hoTen').value.trim();
        var capBac = document.getElementById('capBac').value;
        if (!hoTen || !capBac) {
          showAlert('Vui l√≤ng nh·∫≠p H·ªç t√™n v√† Ch·ªçn c·∫•p b·∫≠c tr∆∞·ªõc khi ch·∫•m v√†o.', 'error');
          return;
        }
        var now = new Date();
        var gioVao = now.toISOString();
        setCurrentDuty({
          hoTen: hoTen,
          capBac: capBac,
          ghiChu: document.getElementById('ghiChu').value.trim(),
          gioVao: gioVao
        });
        updateDutyUI();
        showAlert('ƒê√£ ch·∫•m v√†o l√∫c ' + formatTime(gioVao) + '. Khi tan ca b·∫•m Off Duty ƒë·ªÉ ch·∫•m ra.', 'success');
      });

      document.getElementById('btnOffDuty').addEventListener('click', function () {
        var duty = getCurrentDuty();
        if (!duty) {
          showAlert('Ch∆∞a c√≥ ca l√†m vi·ªác. B·∫•m On Duty ƒë·ªÉ ch·∫•m v√†o tr∆∞·ªõc.', 'error');
          return;
        }
        var now = new Date();
        var gioRa = now.toISOString();
        if (new Date(gioRa) <= new Date(duty.gioVao)) {
          showAlert('Gi·ªù ra ph·∫£i sau gi·ªù v√†o.', 'error');
          return;
        }
        var list = getAttendanceList();
        var newItem = {
          id: Date.now().toString(36) + Math.random().toString(36).slice(2),
          hoTen: duty.hoTen,
          capBac: duty.capBac,
          gioVao: duty.gioVao,
          gioRa: gioRa,
          ghiChu: duty.ghiChu || '',
          status: 'pending',
          createdAt: new Date().toISOString()
        };
        list.push(newItem);
        saveAttendanceList(list);
        setCurrentDuty(null);
        updateDutyUI();
        showAlert('ƒê√£ ch·∫•m ra l√∫c ' + formatTime(gioRa) + '. B·∫£n ghi ƒë√£ g·ª≠i, ch·ªù admin duy·ªát.', 'success');
        loadApproved();
      });

      updateDutyUI();
      loadApproved();
    })();
  </script>
</body>
</html>
