<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n tr·ªã Admin - Web Ch·∫•m C√¥ng</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="site-header">
    <h1>üïê Web Ch·∫•m C√¥ng</h1>
    <nav>
      <a href="index.html">Trang ch·ªß</a>
      <a href="login.html?logout=1">ƒêƒÉng xu·∫•t</a>
      <a href="admin.html" class="active">Qu·∫£n tr·ªã</a>
    </nav>
  </header>

  <main class="container">
    <div id="adminAlert"></div>

    <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
    <section class="card">
      <h2>ƒê·ªïi m·∫≠t kh·∫©u Admin</h2>
      <form id="formDoiMatKhau" style="max-width: 400px;">
        <div class="form-group">
          <label for="currentPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
          <input type="password" id="currentPassword" required>
        </div>
        <div class="form-group">
          <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="newPassword" required minlength="6">
        </div>
        <div class="form-group">
          <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="confirmPassword" required minlength="6">
        </div>
        <button type="submit" class="btn btn-secondary">ƒê·ªïi m·∫≠t kh·∫©u</button>
      </form>
    </section>

    <!-- Danh s√°ch ch·ªù duy·ªát / ch·ªânh s·ª≠a -->
    <section class="card">
      <h2>Qu·∫£n l√Ω ch·∫•m c√¥ng (ch·ªù duy·ªát & ƒë√£ duy·ªát)</h2>
      <div class="table-wrap">
        <table class="data-table" id="tableAll">
          <thead>
            <tr>
              <th>Tr·∫°ng th√°i</th>
              <th>H·ªç t√™n</th>
              <th>C·∫•p b·∫≠c</th>
              <th>Gi·ªù v√†o</th>
              <th>Gi·ªù ra</th>
              <th>Ghi ch√∫</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="tbodyAll"></tbody>
        </table>
      </div>
      <div id="emptyAll" class="empty-state" style="display: none;">
        <p>Ch∆∞a c√≥ b·∫£n ghi ch·∫•m c√¥ng n√†o.</p>
      </div>
    </section>
  </main>

  <!-- Modal ch·ªânh s·ª≠a -->
  <div id="modalEdit" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 1rem;">
    <div class="card" style="max-width: 500px; width: 100%; margin: 0;">
      <h2>Ch·ªânh s·ª≠a ch·∫•m c√¥ng</h2>
      <form id="formEdit">
        <input type="hidden" id="editId">
        <div class="form-group">
          <label for="editHoTen">H·ªç v√† t√™n</label>
          <input type="text" id="editHoTen" required>
        </div>
        <div class="form-group">
          <label for="editCapBac">C·∫•p b·∫≠c</label>
          <select id="editCapBac"></select>
        </div>
        <div class="form-group">
          <label for="editGioVao">Gi·ªù v√†o</label>
          <input type="datetime-local" id="editGioVao" required>
        </div>
        <div class="form-group">
          <label for="editGioRa">Gi·ªù ra</label>
          <input type="datetime-local" id="editGioRa" required>
        </div>
        <div class="form-group">
          <label for="editGhiChu">Ghi ch√∫</label>
          <textarea id="editGhiChu" rows="2"></textarea>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" class="btn btn-primary">L∆∞u</button>
          <button type="button" class="btn btn-secondary" id="btnCloseModal">H·ªßy</button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-app.js"></script>
  <script src="js/data.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script>
    (function () {
      var attendanceList = [];

      function initAdmin() {
      var editCapBac = document.getElementById('editCapBac');
      editCapBac.innerHTML = '';
      LUONG_CAP_BAC.forEach(function (r) {
        var opt = document.createElement('option');
        opt.value = r.rank;
        opt.textContent = r.rank;
        editCapBac.appendChild(opt);
      });

      function showAlert(msg, type) {
        type = type || 'info';
        var box = document.getElementById('adminAlert');
        box.innerHTML = '<div class="alert alert-' + type + '">' + msg + '</div>';
        setTimeout(function () { box.innerHTML = ''; }, 4000);
      }

      function loadTable() {
        function render(list) {
          attendanceList = list || [];
          var tbody = document.getElementById('tbodyAll');
          var empty = document.getElementById('emptyAll');
          tbody.innerHTML = '';
          if (attendanceList.length === 0) {
            empty.style.display = 'block';
            return;
          }
          empty.style.display = 'none';
          attendanceList.forEach(function (row) {
          var tr = document.createElement('tr');
          var statusClass = row.status === 'approved' ? 'badge-approved' : (row.status === 'rejected' ? 'badge-rejected' : 'badge-pending');
          var statusText = row.status === 'approved' ? 'ƒê√£ duy·ªát' : (row.status === 'rejected' ? 'T·ª´ ch·ªëi' : 'Ch·ªù duy·ªát');
          var actions = '';
          if (row.status !== 'rejected') {
            actions += '<button type="button" class="btn btn-secondary btn-edit" data-id="' + row.id + '">S·ª≠a</button>';
          }
          if (row.status === 'pending') {
            actions += '<button type="button" class="btn btn-success btn-approve" data-id="' + row.id + '">Duy·ªát</button>';
            actions += '<button type="button" class="btn btn-danger btn-reject" data-id="' + row.id + '">T·ª´ ch·ªëi</button>';
          }
          tr.innerHTML =
            '<td><span class="badge ' + statusClass + '">' + statusText + '</span></td>' +
            '<td>' + escapeHtml(row.hoTen) + '</td>' +
            '<td>' + escapeHtml(row.capBac) + '</td>' +
            '<td>' + formatDate(row.gioVao) + ' ' + formatTime(row.gioVao) + '</td>' +
            '<td>' + formatDate(row.gioRa) + ' ' + formatTime(row.gioRa) + '</td>' +
            '<td>' + escapeHtml(row.ghiChu || '') + '</td>' +
            '<td class="cell-actions">' + actions + '</td>';
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('.btn-edit').forEach(function (btn) {
          btn.addEventListener('click', function () { openEdit(this.getAttribute('data-id')); });
        });
        tbody.querySelectorAll('.btn-approve').forEach(function (btn) {
          btn.addEventListener('click', function () { setStatus(this.getAttribute('data-id'), 'approved'); });
        });
        tbody.querySelectorAll('.btn-reject').forEach(function (btn) {
          btn.addEventListener('click', function () { setStatus(this.getAttribute('data-id'), 'rejected'); });
        });
        }

        if (useFirebase() || useServer()) {
          apiGetAttendance(false).then(render).catch(function (err) {
            showAlert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch: ' + (err.message || err), 'error');
            render(getAttendanceList());
          });
        } else {
          render(getAttendanceList());
        }
      }

      function setStatus(id, status) {
        if (useFirebase() || useServer()) {
          apiUpdateAttendance(id, { status: status }).then(function () {
            showAlert(status === 'approved' ? 'ƒê√£ duy·ªát b·∫£n ghi.' : 'ƒê√£ t·ª´ ch·ªëi b·∫£n ghi.', 'success');
            loadTable();
          }).catch(function (err) { showAlert(err.message || 'L·ªói c·∫≠p nh·∫≠t.', 'error'); });
          return;
        }
        var list = getAttendanceList();
        var i = list.findIndex(function (x) { return x.id === id; });
        if (i === -1) return;
        list[i].status = status;
        list[i].updatedAt = new Date().toISOString();
        saveAttendanceList(list);
        showAlert(status === 'approved' ? 'ƒê√£ duy·ªát b·∫£n ghi.' : 'ƒê√£ t·ª´ ch·ªëi b·∫£n ghi.', 'success');
        loadTable();
      }

      function openEdit(id) {
        var row = attendanceList.find(function (x) { return x.id === id; });
        if (!row) return;
        document.getElementById('editId').value = row.id;
        document.getElementById('editHoTen').value = row.hoTen;
        document.getElementById('editCapBac').value = row.capBac;
        document.getElementById('editGioVao').value = row.gioVao ? row.gioVao.slice(0, 16) : '';
        document.getElementById('editGioRa').value = row.gioRa ? row.gioRa.slice(0, 16) : '';
        document.getElementById('editGhiChu').value = row.ghiChu || '';
        document.getElementById('modalEdit').style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('modalEdit').style.display = 'none';
      }

      document.getElementById('formEdit').addEventListener('submit', function (e) {
        e.preventDefault();
        var id = document.getElementById('editId').value;
        var gioVao = document.getElementById('editGioVao').value;
        var gioRa = document.getElementById('editGioRa').value;
        if (new Date(gioRa) <= new Date(gioVao)) {
          showAlert('Gi·ªù ra ph·∫£i sau gi·ªù v√†o.', 'error');
          return;
        }
        var data = {
          hoTen: document.getElementById('editHoTen').value.trim(),
          capBac: document.getElementById('editCapBac').value,
          gioVao: gioVao,
          gioRa: gioRa,
          ghiChu: document.getElementById('editGhiChu').value.trim()
        };
        if (useFirebase() || useServer()) {
          apiUpdateAttendance(id, data).then(function () {
            showAlert('ƒê√£ l∆∞u ch·ªânh s·ª≠a.', 'success');
            closeModal();
            loadTable();
          }).catch(function (err) { showAlert(err.message || 'L·ªói c·∫≠p nh·∫≠t.', 'error'); });
          return;
        }
        var list = getAttendanceList();
        var i = list.findIndex(function (x) { return x.id === id; });
        if (i === -1) return;
        list[i].hoTen = data.hoTen;
        list[i].capBac = data.capBac;
        list[i].gioVao = data.gioVao;
        list[i].gioRa = data.gioRa;
        list[i].ghiChu = data.ghiChu;
        list[i].updatedAt = new Date().toISOString();
        saveAttendanceList(list);
        showAlert('ƒê√£ l∆∞u ch·ªânh s·ª≠a.', 'success');
        closeModal();
        loadTable();
      });

      document.getElementById('btnCloseModal').addEventListener('click', closeModal);
      document.getElementById('modalEdit').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
      });

      document.getElementById('formDoiMatKhau').addEventListener('submit', function (e) {
        e.preventDefault();
        var current = document.getElementById('currentPassword').value;
        var newP = document.getElementById('newPassword').value;
        var confirm = document.getElementById('confirmPassword').value;
        if (newP !== confirm) {
          showAlert('M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp.', 'error');
          return;
        }
        if (useFirebase() || useServer()) {
          apiChangePassword(current, newP).then(function () {
            showAlert('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng.', 'success');
            e.target.reset();
          }).catch(function (err) { showAlert(err.message || 'L·ªói ƒë·ªïi m·∫≠t kh·∫©u.', 'error'); });
          return;
        }
        var admin = getAdminUser();
        if (!admin || admin.password !== current) {
          showAlert('M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng.', 'error');
          return;
        }
        setAdminUser({ username: admin.username, password: newP });
        showAlert('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng.', 'success');
        this.reset();
      });

      loadTable();
      }

      if (useFirebase()) {
        firebaseOnAuthState(function (user) {
          if (user) initAdmin();
          else window.location.href = 'login.html';
        });
        return;
      }
      if (useServer()) {
        if (!getToken()) { window.location.href = 'login.html'; return; }
        apiMe().then(initAdmin).catch(function () { setToken(null); if (typeof apiLogout === 'function') apiLogout(); window.location.href = 'login.html'; });
        return;
      }
      if (typeof isAdminLoggedIn !== 'function' || !isAdminLoggedIn()) { window.location.href = 'login.html'; return; }
      initAdmin();
    })();
  </script>
</body>
</html>
